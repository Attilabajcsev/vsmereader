# IXBRL VSME Reader — MVP

Minimal, authenticated web app to upload and validate EFRAG VSME Inline XBRL, derive a normalized per-company/year register, explore reports and facts, view an ESG summary, and inspect the original report inline.

## Overview
- Frontend: SvelteKit + Tailwind (DaisyUI), JWT cookies, API proxy at `/api/*`.
- Backend: Django REST Framework + SimpleJWT, Arelle for iXBRL validation and OIM JSON extraction.
- Database: PostgreSQL (dev can fall back to SQLite if no POSTGRES_* envs).
- Files: Uploaded reports stored under `backend/media/reports`, derived OIM JSON under `backend/media/reports/oim`.

## Core features (current state)
- Submit report
  - Create a company and upload a report for a given tax year.
  - Accepts `.xhtml`, `.html` (auto-wrapped server-side into a minimal IXDS), or `.zip` IXDS.
  - Enforces one report per company-year.
- Portfolio (reports list)
  - Card-style list of your reports with Company, Entity, Year, Status, Period, Created.
  - Actions: Open (detail), Inspect (inline viewer), Delete.
- Report detail
  - vSME ESG Summary (5 datapoints: GHG, Energy, Water, Waste, Employees) with present/missing flags.
  - “View datapoint” applies a facts filter; “Copy value” copies the raw value.
  - Facts table with keyword filter and pagination.
  - Download original iXBRL and extracted OIM JSON.
- Register (company-year)
  - Normalized `VsmeRegister` row per company-year populated after validation.
  - Detail page shows core metrics with units and the source concept map; link to last report.
  - List and CSV export endpoints (SQL-backed filters: company name, year range, min completeness).
- Insights
  - Portfolio KPIs and three aggregated charts focused on Total GHG, Energy consumption, and Waste generated by year.
- Inline report viewer
  - `/api/reports/{id}/document/` serves the primary HTML/XHTML with `<base>` injection.
  - `/api/reports/{id}/asset/{member}` serves assets when the upload is a ZIP.

## Architecture & key modules
- Backend Django app `api`:
  - Models: `Company`, `Report`, `Fact`, `VsmeRegister` (unique: Report by company/year; VsmeRegister by company/year).
  - Processing: `processing.py` wraps `.html` uploads into IXDS ZIP, runs Arelle CLI with Save Loadable OIM, extracts facts and metadata, upserts `VsmeRegister`.
  - Register mapping: `register.py` derives stable vSME fields and a completeness score; stores `source_concepts` JSON.
  - Views: report upload/list/detail/facts/summary, companies list/create, vsme-register list/detail/export CSV, inline report document/asset.
  - URLs: `api/urls.py` exposes the above under `/api/...`.
- Frontend SvelteKit routes (authenticated shell):
  - `/(app)/portfolio`: list of reports; search by company name; Open/Inspect/Delete actions.
  - `/(app)/reports/[id]`: report detail (ESG summary, facts table, downloads, Inspect).
  - `/(app)/portfolio/[company]/[year]`: register detail (metrics + source concepts + link to last report + Inspect).
  - `/(app)/submit`: create company + upload report for a year.
  - `/(app)/insights`: KPIs and aggregated charts for GHG/Energy/Waste totals by year.
  - `/api/[...path]`: proxy for the backend API (handles multipart form-data, redirects).

## API map (selected)
- Auth (SimpleJWT): `POST /api/login/`, `POST /api/token/refresh/` (existing); optional Google OAuth `POST /api/oauth-google/`.
- Companies: `GET/POST /api/companies/` (POST idempotent by name, authed).
- Reports:
  - `POST /api/reports/upload` (multipart: original_file, company, reporting_year)
  - `GET /api/reports/` (q filter: company name | entity | period or exact 4-digit year)
  - `GET /api/reports/{id}/` | `GET /api/reports/{id}/facts/` (paged) | `GET /api/reports/{id}/summary/`
  - `GET /api/reports/{id}/download/original/` | `GET /api/reports/{id}/download/oim-json/`
  - Inline viewing: `GET /api/reports/{id}/document/` | `GET /api/reports/{id}/asset/{member}`
- vSME Register:
  - `GET /api/vsme-register/` (filters: company, year or year_from/year_to, min_completeness)
  - `GET /api/vsme-register/{companyId}/{year}/`
  - `GET /api/vsme-register/export/csv/` (respects same filters)

## Processing pipeline (backend)
1) Save upload; if `.html`, auto-wrap into a temp IXDS ZIP with `META-INF/reportPackage.json` and the HTML under `reports/`.
2) Run Arelle CLI (Save Loadable OIM + Inline XBRL Document Set) to export OIM xBRL-JSON.
3) Persist facts in `Fact` and update `Report` metadata/status.
4) Upsert `VsmeRegister` for `(company, year)` with core ESG metrics and a completeness score.

## Configuration
- Backend `.env` (example):
  - `SECRET_KEY=...`
  - `DEBUG=True` (enable for local only)
  - `POSTGRES_DB=...`, `POSTGRES_USER=...`, `POSTGRES_PASSWORD=...`, `POSTGRES_HOST=...`, `POSTGRES_PORT=5432`
  - `ARELLE_CACHE_DIR=/app/arelle_cache`
  - `ARELLE_PLUGINS=saveLoadableOIM,inlineXbrlDocumentSet`
  - `VSME_ENTRYPOINT_URL=https://xbrl.efrag.org/taxonomy/vsme/2024-12-17/vsme-all.xsd`
  - `MAX_UPLOAD_SIZE_MB=50`
- Frontend `.env` (example):
  - `BACKEND_URL=http://localhost:8000/api`

## Local development
Using Docker Compose (frontend dev server + Django dev server + Postgres):
1) `docker-compose up` (builds `backend` and `frontend`, starts `db`).
2) Open `http://localhost:5173` and log in (JWT cookies). Upload a report from Submit, or use Portfolio to explore.

Windows note: if you hit
`Cannot find module @rollup/rollup-win32-x64-msvc` during frontend install, remove `node_modules` and `package-lock.json` and run `npm i` again (known npm optional dependency bug).

## Known behaviors and fixes already in place
- Accept `.html` uploads: backend auto-wraps them into a valid IXDS for Arelle.
- Proxying multipart form-data: SvelteKit API proxy rebuilds FormData to preserve files and avoids redirect body loss.
- Companies POST without trailing slash: backend accepts both `/api/companies` and `/api/companies/`.
- Portfolio and navigation refined: login redirects to `/portfolio`; logout returns to login; links hide when not authenticated.
- Inline viewer for zipped uploads: `<base>` injection + asset endpoint resolve relative URLs.

## Handover: hardening & deployment checklist (next steps)
Prioritized items for productionizing (do not change behavior):
1) Security & settings
   - Set `DEBUG=False`, tighten `ALLOWED_HOSTS`, secure cookies, CSRF trusted origins, HSTS, SSL redirect.
   - Default DRF permission to `IsAuthenticated` and explicitly allow public endpoints.
2) Runtime
   - Run Django with Gunicorn/Uvicorn behind a reverse proxy (Nginx/Cloud load balancer).
   - Serve static/media correctly; persist `backend/media` (volume or object storage).
3) Build & images
   - Multi-stage backend image (pin Python and Arelle commit; install `libpq-dev`).
   - Frontend production build (`vite build` + appropriate SvelteKit adapter) and serve behind the same proxy.
4) Database
   - Use managed Postgres; run migrations at startup; set backups; monitor connections.
5) Arelle
   - Ensure Save Loadable OIM plugin availability and consistent version; validate on representative samples.
6) Observability
   - Structured logs, request IDs, error reporting (Sentry), basic health endpoints.
7) Access control & rate limits
   - Confirm all API routes are auth-protected, add rate limiting and CORS (if cross-domain).
8) Data retention & quotas
   - Set limits for file size, retention policy for media/OIM JSON.
9) CI/CD
   - Build, test, and push images; deploy with environment-specific configs and secrets.

This README reflects the current state of the MVP and provides the context and concrete next actions for a follow-up hardening and deployment pass.
